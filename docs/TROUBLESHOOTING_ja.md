# 🔧 Kindle TTS Reader - トラブルシューティングガイド

**バージョン**: 1.1.0
**最終更新日**: 2025年12月20日

---

## 📋 クイック診断

**問題カテゴリー:**
- [インストール問題](#インストール問題)
- [権限の問題](#権限の問題)
- [OCRが動作しない](#ocrが動作しない)
- [テキスト読み上げの問題](#テキスト読み上げの問題)
- [自動ページめくりの失敗](#自動ページめくりの失敗)
- [パフォーマンスの問題](#パフォーマンスの問題)
- [Gemini APIエラー](#gemini-apiエラー)
- [学習機能の問題](#学習機能の問題-v110)
- [クラッシュとフリーズ](#クラッシュとフリーズ)

---

## 📦 インストール問題

### 問題: 「アプリがインストールされませんでした」エラー

**症状:**
- 一般的なエラーメッセージでインストールが失敗
- APKが開かない

**考えられる原因:**
1. ストレージ容量不足
2. APKダウンロードが破損
3. 既存インストールと競合
4. Androidバージョンが古すぎる

**解決策:**

**解決策1: ストレージを空ける**
```
設定 → ストレージ → 空き容量を増やす
```
- 未使用アプリを削除
- アプリキャッシュをクリア
- 写真をクラウドに移動
- **必要**: 最低100MB

**解決策2: APKを再ダウンロード**
1. 破損したAPKファイルを削除
2. ブラウザキャッシュをクリア
3. GitHub Releasesから再ダウンロード
4. ファイルサイズを確認: 正確に83MB

**解決策3: 古いバージョンをアンインストール**
```bash
# ADB経由（開発者向け）
adb uninstall com.kindletts.reader

# 設定経由
設定 → アプリ → Kindle TTS Reader → アンインストール
```

**解決策4: Androidバージョンを確認**
1. 設定 → 端末情報 → Androidバージョン
2. 最小要件: Android 5.0 (API 21)
3. それ以前の場合: デバイスは非対応

---

### 問題: インストール中の「解析エラー」

**症状:**
- 「パッケージの解析中に問題が発生しました」

**考えられる原因:**
- APKが破損または不完全なダウンロード
- アーキテクチャが間違っている（稀）
- ファイルシステムの破損

**解決策:**

1. **公式ソースからAPKを再ダウンロード**
   - 使用するのは: https://github.com/smartnavipro-dev/kindle-tts-reader/releases のみ
   - サードパーティのAPKサイトは避ける

2. **APKの整合性を確認**
   ```bash
   # 予想サイズ
   83 MB (87,031,808 バイト)

   # MD5チェックサム（現在のハッシュはリリースページで確認）
   md5sum kindle-tts-reader-v1.1.0-release.apk
   ```

3. **別のファイルマネージャーを使用**
   - 試す: Files by Google、Solid Explorer

---

## 🔐 権限の問題

### 問題: オーバーレイ権限が拒否されるまたは機能しない

**症状:**
- アプリに「準備完了」と表示されるが、オーバーレイが表示されない
- 設定ボタンがオーバーレイ権限画面を開かない

**解決策:**

**解決策1: オーバーレイを手動で有効化**
```
設定 → アプリ → 特別なアプリアクセス → 他のアプリの上に重ねて表示
→ Kindle TTS Reader → 許可
```

**解決策2: バッテリー最適化を確認**
```
設定 → アプリ → Kindle TTS Reader → バッテリー
→ 制限なし（最適化しないに設定）
```

**解決策3: アプリと電話を再起動**
1. アプリを強制停止（設定 → アプリ → Kindle TTS Reader → 強制停止）
2. 電話を再起動
3. アプリを再度開き、権限を許可

---

### 問題: アクセシビリティサービスが無効になり続ける

**症状:**
- 自動ページめくりが一時的に動作してから停止
- 設定でアクセシビリティサービスがOFFと表示される

**考えられる原因:**
- バッテリー最適化がサービスを終了
- セキュリティアプリの干渉
- システムメモリの圧迫

**解決策:**

**解決策1: バッテリー最適化を無効化**
```
設定 → アプリ → Kindle TTS Reader → バッテリー
→ 最適化しない（または制限なし）
```

**解決策2: 最近使用したアプリでアプリをロック**
- 最近使用したアプリを開く（□ボタン）
- Kindle TTS Readerを見つける
- ロックアイコン（📌）をタップして終了を防止

**解決策3: セキュリティアプリでホワイトリストに追加**
- ウイルス対策を使用している場合: ホワイトリストに追加
- 一般的なアプリ: Avast、Norton、McAfee
- 「自動ブースト」機能を無効化

**解決策4: サービスを再有効化**
```
設定 → ユーザー補助 → ダウンロード済みのサービス
→ Kindle TTS Auto Page Turn → OFFにしてからONに切り替え
```

---

### 問題: 画面キャプチャ権限が毎回要求される

**症状:**
- 毎回権限プロンプトが表示される
- 「今後表示しない」チェックボックスが機能しない

**原因:**
- これはMediaProjectionの通常のAndroid動作
- 権限はセッションベースであり、永続的ではない

**回避策:**
- これを予想される動作として受け入れる
- 将来のAndroidバージョンでは永続的な許可が可能になる可能性
- 各セッションで「今すぐ開始」をタップ

---

## 🔍 OCRが動作しない

### 問題: Kindle画面からテキストが抽出されない

**症状:**
- ステータスが「処理中...」で無期限に表示
- TTSが開始されない
- オーバーレイに空のテキストが表示される

**診断手順:**

**ステップ1: 画面コンテンツを確認**
- Kindleアプリが実際のテキストページを表示しているか？
- 画像のみのページはOCRできない
- 明確なテキストのある別のページを試す

**ステップ2: OCRログを確認（開発者モード）**
```bash
# ADB経由
adb logcat | grep "KindleTTS_OCR"

# 確認項目:
# - "No text found" = OCRがテキストを見つけられなかった
# - "Confidence: 0.XX" = 信頼度が低い
```

**解決策:**

**解決策1: テキスト品質を改善**
- Kindleフォントサイズを大きくする（Aaボタン → より大きく）
- 高コントラストテーマを使用（白地に黒テキスト）
- 画面の明るさを十分に確保
- 指紋から画面をきれいにする

**解決策2: OCRプロセスを再起動**
1. オーバーレイで「停止」をタップ
2. メイン画面に戻る
3. 「読み上げ開始」を再度タップ

**解決策3: アプリキャッシュをクリア**
```
設定 → アプリ → Kindle TTS Reader
→ ストレージ → キャッシュを削除（データ削除ではない）
```

---

### 問題: OCRが文字化けまたは誤った文字を抽出

**症状:**
- TTSが意味不明な音を読む
- 抽出されたテキストが文字化け

**考えられる原因:**
1. Kindleブックの変わったフォント
2. OCR信頼度が低い
3. 画面キャプチャ品質の問題

**解決策:**

**解決策1: Kindleフォントを変更**
```
Kindleアプリ → Aaボタン → フォントファミリー
→ 試す: Bookerly、Ember、Palatino
```

**解決策2: Gemini APIを確認**
- APIキーが有効であることを確認
- APIクォータが超過していないか確認
- モニター: https://aistudio.google.com/app/apikey

**解決策3: 学習を有効化/無効化**
```
設定 → ローカル学習機能 → OFFに切り替え
```
- 学習なしで試して問題を切り分け
- 学習なしで動作する場合: 学習データを削除して再有効化

---

## 🔊 テキスト読み上げの問題

### 問題: 音が出ない / 無音再生

**症状:**
- オーバーレイに抽出されたテキストが表示される
- ステータスに「読み上げ中...」と表示
- しかし音声出力がない

**診断手順:**

**ステップ1: システム音量を確認**
- メディア音量（着信音ではない）が0より大きい必要がある
- YouTubeまたは音楽アプリでテスト

**ステップ2: TTSエンジンを確認**
```
設定 → システム → 言語と入力 → テキスト読み上げの出力
→ 優先エンジン: Google テキスト読み上げ
```

**解決策:**

**解決策1: TTSエンジンをインストール**
1. Google Playストアを開く
2. 「Google テキスト読み上げ」を検索
3. 更新またはインストール
4. 日本語音声データをダウンロード

**解決策2: TTSをテスト**
```
設定 → システム → 言語と入力 → テキスト読み上げの出力
→ サンプルを再生/聞く
```
- サンプルが動作しない場合: TTSシステムの問題
- TTSエンジンを再インストール

**解決策3: TTSエンジンを変更**
```
代替エンジンを試す:
- Samsung TTS（Samsungデバイスの場合）
- eSpeak TTS（無料、基本的）
```

---

### 問題: 誤った言語の発音

**症状:**
- 日本語のテキストが英語のアクセントで読まれる
- 英語のテキストが日本語のアクセントで読まれる

**原因:**
- TTSエンジンが文ごとに言語を自動検出
- 混在言語の本はTTSを混乱させる可能性

**解決策:**

**解決策1: 言語を手動で指定**
```
設定 → システム → 言語と入力 → テキスト読み上げの出力
→ 言語: 日本語
```

**解決策2: 言語固有のTTSを使用**
- 日本語の本の場合: HOYA ReadSpeaker、N2 TTS
- 英語の本の場合: Google TTS（en-US音声）

---

### 問題: 途切れるまたはロボット的な音声

**原因:**
- 低品質のTTS音声データ
- システムパフォーマンスの問題

**解決策:**

**解決策1: HD音声をダウンロード**
```
設定 → システム → 言語と入力 → テキスト読み上げの出力
→ 設定アイコン（⚙️） → 音声データをインストール
→ HD/拡張音声をダウンロード
```

**解決策2: 読み上げ速度を調整**
```
設定 → システム → 言語と入力 → テキスト読み上げの出力
→ 読み上げ速度: 80%から100%を試す
```
- 速すぎる（>100%）= 途切れる
- 遅すぎる（<80%）= ロボット的

---

## 📄 自動ページめくりの失敗

### 問題: ページが自動的にめくれない

**症状:**
- TTSが読み上げを終了
- 同じページに留まる
- 手動スワイプは動作

**診断手順:**

**ステップ1: アクセシビリティサービスを確認**
```
設定 → ユーザー補助 → ダウンロード済みのサービス
→ Kindle TTS Auto Page Turn: ONである必要がある
```

**ステップ2: Kindleアプリのバージョンを確認**
- Kindleを最新バージョンに更新
- バージョンによってタップゾーンが異なる可能性

**解決策:**

**解決策1: タップ位置を再調整**
1. Kindleブックを開く
2. ページ送りタップゾーンがどこにあるかメモ
3. （開発者）AutoPageTurnService.ktで座標を調整
4. （ユーザー）Kindleバージョン番号とともに問題を報告

**解決策2: ページめくり前の遅延を増やす**
- 将来のバージョンでは調整可能な遅延を提供予定
- 現在: TTS完了後2秒遅延

**解決策3: 手動モード**
- 設定で自動ページめくりを無効化
- 準備ができたら手動でスワイプ

---

### 問題: ページが速くめくれすぎる

**原因:**
- ユーザーがオーバーレイテキストを読み終える前にTTSが完了
- 遅延タイミングの不一致

**一時的な回避策:**
- TTSの読み上げ速度を遅くする
- 将来の更新で設定可能な遅延を追加予定

---

## ⚡ パフォーマンスの問題

### 問題: アプリが遅い / ラグがある

**症状:**
- タップへの応答が遅れる
- OCR処理が遅い（>5秒）
- TTSが途切れる

**解決策:**

**解決策1: RAMを解放**
1. バックグラウンドアプリを閉じる
2. デバイスを再起動
3. ゲーム/重いマルチタスク中は使用しない

**解決策2: アプリキャッシュをクリア**
```
設定 → アプリ → Kindle TTS Reader
→ ストレージ → キャッシュを削除
```

**解決策3: 負荷を軽減**
- 一時的に学習を無効化
- Kindleフォントサイズを小さくする（処理するテキストが少なくなる）

---

### 問題: バッテリー消費が激しい

**症状:**
- 1時間あたりバッテリーが20%以上減る
- デバイスが熱くなる

**原因:**
- 継続的な画面キャプチャ（予想される）
- Gemini API呼び出し（ネットワーク）
- TTSエンジン処理

**予想されるバッテリー使用量:**
- 通常: 1時間あたり10-15%
- 高負荷使用: 1時間あたり15-20%

**軽減策:**
- 画面の明るさを下げる
- モバイルデータの代わりにWi-Fiを使用
- 他のバックグラウンドアプリを閉じる
- デバイスが過熱していないか確認（熱い場合は一時停止）

---

## 🤖 Gemini APIエラー

### 問題: 「APIキーが無効」エラー

**症状:**
- OCRがテキストを抽出するが補正が失敗
- ログに認証エラーが表示される

**解決策:**

**解決策1: APIキーを確認**
1. アクセス: https://aistudio.google.com/app/apikey
2. キーのステータスを確認: アクティブ vs 制限付き
3. 権限を確認: Gemini APIが有効

**解決策2: APIキーを再生成**
1. 古いキーを削除
2. 新しいキーを作成
3. 新しいキーでアプリを再ビルド（ソースビルド）

**ビルド済みAPKの場合:**
- APIキーが埋め込まれている
- 再ビルドなしでは変更できない
- デフォルトキーが失敗した場合は開発者に連絡

---

### 問題: 「クォータ超過」エラー

**症状:**
- 最初は動作するが、その後失敗
- クォータ/制限に関するエラーメッセージ

**原因:**
- 無料枠: 1日あたり500リクエストを超過
- 有料枠: 月間クォータに到達

**解決策:**

**解決策1: 使用量を確認**
```
アクセス: https://aistudio.google.com/app/apikey
→ APIキーを表示 → 使用量メトリクス
```

**解決策2: クォータのリセットを待つ**
- 日次クォータは太平洋時間の深夜にリセット
- または: 有料プランにアップグレード

**解決策3: API呼び出しを削減**
```
設定 → 一時的に学習を無効化
→ キャッシュされた補正を使用
→ すでに処理した本を読む
```

---

### 問題: Gemini APIの応答が遅い

**症状:**
- OCRに10-15秒かかる
- 「処理中...」が続く

**原因:**
- インターネット接続が遅い
- APIサーバーの混雑（稀）

**解決策:**

1. **より高速なネットワークに切り替え**
   - Wi-Fi > モバイルデータ
   - 4G/5G > 3G

2. **レイテンシを確認**
   ```bash
   ping google.com
   # 良好なパフォーマンスには<50msである必要がある
   ```

3. **再試行ロジック**
   - アプリは失敗したリクエストを自動的に再試行
   - 強制停止する前に10秒待つ

---

## 🧠 学習機能の問題 (v1.1.0+)

### 問題: 学習パターンが保存されない

**症状:**
- 補正を行うが定着しない
- 統計に0パターンと表示される

**診断手順:**

**ステップ1: 有効化されているか確認**
```
設定 → ローカル学習機能 → ONである必要がある
```

**ステップ2: ストレージ権限を確認**
```
設定 → アプリ → Kindle TTS Reader → 権限
→ ストレージ: 許可されている必要がある
```

**解決策:**

**解決策1: 学習を再有効化**
1. 設定 → 学習をOFFに切り替え
2. アプリを再起動
3. 設定 → 学習をONに切り替え
4. 同意ダイアログを再度受け入れる

**解決策2: ストレージを確認**
```
設定 → ストレージ
→ 50MB以上の空き容量を確保
```

---

### 問題: 学習データを削除できない

**症状:**
- 「すべてのデータを削除」ボタンが機能しない
- 削除後もパターンが表示される

**解決策:**

**解決策1: 強制クリア**
```
設定 → アプリ → Kindle TTS Reader
→ ストレージ → データを削除
```
**警告**: これにより設定を含むすべてのアプリデータが削除されます

**解決策2: アプリを再インストール**
1. 完全にアンインストール
2. APKから再インストール
3. 新規開始

---

## 💥 クラッシュとフリーズ

### 問題: 起動時にアプリがクラッシュ

**症状:**
- アプリが開いてすぐに閉じる
- 「Kindle TTS Readerが停止しました」メッセージ

**解決策:**

**解決策1: アプリデータをクリア**
```
設定 → アプリ → Kindle TTS Reader
→ ストレージ → データを削除 → OK
```
**注意**: これによりすべての設定がリセットされます

**解決策2: アプリを再インストール**
1. 完全にアンインストール
2. デバイスを再起動
3. 公式APKから再インストール

**解決策3: Android System WebViewを確認**
```
Playストア → 「Android System WebView」を検索
→ 利用可能な場合は更新
```

---

### 問題: 読み上げ中にアプリがフリーズ

**症状:**
- オーバーレイが応答しなくなる
- コントロールをタップできない
- ステータスが停止

**解決策:**

**解決策1: 強制停止**
```
電源ボタン長押し → 最近使用したアプリ → Kindle TTS Readerをスワイプして消去
または: 設定 → アプリ → Kindle TTS Reader → 強制停止
```

**解決策2: クラッシュログを収集**
```bash
# ADB経由（バグレポート用）
adb logcat > crash_log.txt
```
- 送信先: contact@smartnavipro.dev

---

## 🔍 高度なデバッグ

### 開発者モードを有効化

**詳細な診断のため:**

1. **Android開発者オプションを有効化**
   ```
   設定 → 端末情報 → 「ビルド番号」を7回タップ
   ```

2. **USBデバッグを有効化**
   ```
   設定 → 開発者向けオプション → USBデバッグ: ON
   ```

3. **デバイスをPCに接続**
   ```bash
   adb devices
   # デバイスが表示される必要がある
   ```

4. **ログをキャプチャ**
   ```bash
   # リアルタイムログ
   adb logcat | grep "KindleTTS"

   # コンポーネント別にフィルタ
   adb logcat | grep "OCR"
   adb logcat | grep "TTS"
   adb logcat | grep "Gemini"

   # ファイルに保存
   adb logcat > kindle_tts_debug.log
   ```

---

## 📞 ヘルプを得る

### バグを報告する前に

以下の情報を収集してください:

- **デバイス**: メーカー、モデル（例: 「Samsung Galaxy S21」）
- **Androidバージョン**: 設定 → 端末情報
- **アプリバージョン**: 設定 → アプリ → Kindle TTS Reader（1.1.0である必要がある）
- **Kindleバージョン**: Playストア → マイアプリ → Kindle → バージョン
- **再現手順**: 問題を引き起こす正確なアクション
- **ログ**: 可能であれば、adb logcat出力を添付

### 報告チャンネル

- **バグ報告**: https://github.com/smartnavipro-dev/kindle-tts-reader/issues
- **質問**: https://github.com/smartnavipro-dev/kindle-tts-reader/discussions
- **メール**: contact@smartnavipro.dev
- **プライバシー問題**: privacy@smartnavipro.dev

---

## 📚 関連ドキュメント

- 📖 [セットアップガイド](SETUP_GUIDE_ja.md)
- ❓ [拡張FAQ](FAQ_EXTENDED_ja.md)
- 🔒 [プライバシーガイド](PRIVACY_GUIDE_ja.md)
- 📱 [メインREADME](../README_ja.md)

---

**まだ問題がありますか？ お気軽にお問い合わせください！ 🤝**

---

*最終更新: 2025年12月20日*
*ドキュメントバージョン: 1.0*
*アプリバージョン: 1.1.0*
